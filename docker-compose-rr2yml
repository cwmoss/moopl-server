---
services:
  franken:
    # image: dunglas/frankenphp
    image: franken-dev
    build:
      context: ./
      dockerfile: docker/Dockerfile.franken
    ports:
      - "80:80" # HTTP
      - "443:443" # HTTPS
      - "443:443/udp" # HTTP/3
    volumes:
      - ./:/app/public
      - caddy_data:/data
      - caddy_config:/config
    # comment the following line in production, it allows to have nice human-readable logs in dev
    tty: true
  mpd:
    image: moopl-dev
    build:
      context: ./
      dockerfile: docker/Dockerfile
    #devices:
    #  - /dev/snd:/dev/snd
    ports:
      - 6606:6600/tcp # mpd
      - 3636:3636/tcp # rr
      - 6001:6001/tcp # rr rpc
      - 3637:8000/tcp # centrifugo
    environment:
      - PULSE_SERVER=host.docker.internal
      - PULSE_AUDIO_OUTPUT_CREATE=yes
      - USER_MODE=Y
      - PUID=1000
      - PGID=1000
      - AUDIO_GID=29
      - SOXR_PLUGIN_ENABLE=Y
      - SOXR_PLUGIN_QUALITY=custom
      - SOXR_PLUGIN_PRECISION=28
      - SOXR_PLUGIN_PHASE_RESPONSE=45
      - SOXR_PLUGIN_PASSBAND_END=95
      - SOXR_PLUGIN_STOPBAND_BEGIN=105
      - SOXR_PLUGIN_ATTENUATION=4
      - xALSA_OUTPUT_CREATE=yes
      - xALSA_OUTPUT_NAME=aune-s6
      - xALSA_OUTPUT_DEVICE=hw:DAC
      - xALSA_OUTPUT_MIXER_CONTROL=S6 USB DAC Output
      - xALSA_OUTPUT_MIXER_DEVICE=hw:DAC
      - xALSA_OUTPUT_MIXER_TYPE=hardware
      - xALSA_OUTPUT_INTEGER_UPSAMPLING=yes
      - xALSA_OUTPUT_ALLOWED_FORMATS=384000:*:* 352800:*:* *:dsd:*
    volumes:
      - ./docker/mpd.conf:/user/config/override.mpd.conf
      - ~/.config/pulse:/home/mpd-user/.config/pulse
      - ./lastfm.txt:/user/config/lastfm.txt:ro
      - ./librefm.txt:/user/config/librefm.txt:ro
      - ~/Music:/music:ro
      - ./:/moopl
      - ./docker/configure-mpd.sh:/app/bin/configure-mpd.sh
      - ./docker/centrifugo.json:/etc/centrifugo/config.json
    restart: unless-stopped
    #entrypoint: ["/usr/bin/rr", "serve", "--dotenv", ".env", "-c", ".rr.docker.yaml"]
    #entrypoint: ["/app/bin/run-mpd.sh"]

# Volumes needed for Caddy certificates and configuration
volumes:
  caddy_data:
  caddy_config:
